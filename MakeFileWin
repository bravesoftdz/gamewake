PROJECTNAME=GameWake
WIN32DIR=bin\Win32
WIN32EXE=$(WIN32DIR)\$(PROJECTNAME).exe
PORTABLE32EXE=$(WIN32DIR)\Portable\$(PROJECTNAME).exe
WIN64DIR=bin\Win64
WIN64EXE=$(WIN64DIR)\$(PROJECTNAME).exe
PORTABLE64EXE=$(WIN64DIR)\Portable\$(PROJECTNAME).exe
CERTSHA1=A9A273A222A5DD3ED9EC2F46232AAD8E087EA4ED
MSBUILD=C:\Windows\Microsoft.NET\Framework\v3.5\MSBUILD.exe
ZIP="C:\Program Files (x86)\GnuWin32\bin\zip.exe"
INNOSETUP="C:\Program Files (x86)\Inno Setup 5\Compil32.exe"
SIGNTOOL="C:\Program Files (x86)\Windows Kits\8.1\bin\x86\signtool.exe"
SIGN=$(SIGNTOOL) sign /v /sha1 $(CERTSHA1) /tr http://timestamp.globalsign.com/scripts/timstamp.dll /td SHA256 /fd SHA256

build: win32 win64

source:
	$(ZIP) -9 -r $(PROJECTNAME)-src.zip . src -x .hg\* -x debian\* -x setup\* -i MakeFile -i MakeFileWin -i MakeFile.bat -i src\lang -i src\gamewake.desktop -i *.txt -i *.md -i *.pas -i *.dproj -i *.res -i *.rc -i *.dpr -i *.dfm -i *.inc -i *.dcr -i *.ico

win32: src\$(PROJECTNAME).dproj
	SET BDS=C:\Program Files (x86)\Embarcadero\Studio\16.0
	$(MSBUILD) /p:Config=Release /property:Platform=Win32 src\$(PROJECTNAME).dproj

win64: src\$(PROJECTNAME).dproj
	SET BDS=C:\Program Files (x86)\Embarcadero\Studio\16.0
	$(MSBUILD) /p:Config=Release /property:Platform=Win64 src\$(PROJECTNAME).dproj

sign: $(WIN32EXE) $(WIN64EXE)
	$(SIGN) $(WIN32EXE) $(WIN64EXE)
	move $(WIN32EXE) "$(WIN32DIR)\Game Wake.exe"
	move $(WIN64EXE) "$(WIN64DIR)\Game Wake.exe"

buildsetup: setup\$(PROJECTNAME).iss
	$(INNOSETUP) /cc setup\$(PROJECTNAME).iss

release: win32 win64 sign buildsetup portable source

win32portable: src\$(PROJECTNAME).dproj
	SET BDS=C:\Program Files (x86)\Embarcadero\Studio\16.0
	$(MSBUILD) /p:Config=Portable /property:Platform=Win32 src\$(PROJECTNAME).dproj

win64portable: src\$(PROJECTNAME).dproj
	SET BDS=C:\Program Files (x86)\Embarcadero\Studio\16.0
	$(MSBUILD) /p:Config=Portable /property:Platform=Win64 src\$(PROJECTNAME).dproj

signportable: $(PORTABLE32EXE) $(PORTABLE64EXE)
	$(SIGN) $(PORTABLE32EXE) $(PORTABLE64EXE)
	move $(PORTABLE32EXE) "$(WIN32DIR)\Portable\Game Wake.exe"
	move $(PORTABLE64EXE) "$(WIN64DIR)\Portable\Game Wake.exe"

portable: win32portable win64portable signportable

clean:
	DEL src\$(PROJECTNAME).res
	IF EXIST $(WIN32EXE) DEL $(WIN32EXE)
	IF EXIST $(WIN64EXE) DEL $(WIN64EXE)
	IF EXIST $(PORTABLE32EXE) DEL $(PORTABLE32EXE)
	IF EXIST $(PORTABLE64EXE) DEL $(PORTABLE64EXE)
